name: kind
on:
  push:
    branches: [ action-debug ]

env:
  # Common versions
  GO_VERSION: '1.16'
  GO_REQUIRED_MIN_VERSION: ''
  GOPATH: '/home/runner/work/klusterlet-addon-controller/klusterlet-addon-controller/go'
defaults:
  run:
    working-directory: go/src/github.com/open-cluster-management/klusterlet-addon-controller

jobs:
  debug-action:
    name: e2e-debug
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 1
          path: go/src/github.com/open-cluster-management/klusterlet-addon-controller
      - name: install Go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: install imagebuilder
        run: go install github.com/openshift/imagebuilder/cmd/imagebuilder@v1.2.1
      - name: images
        run: make build-image
      - name: setup kind
        uses: engineerd/setup-kind@v0.5.0
        with:
          version: v0.11.1
      - name: Load image on the nodes of the cluster
        run: |
          kind load docker-image --name=kind quay.io/open-cluster-management/klusterlet-addon-controller:latest
      - uses: shaowenchen/debugger-action@v2
        name: debugger
        timeout-minutes: 300
        continue-on-error: true
        with:
          ngrok_token: ${{ secrets.NGROK_TOKEN }}
      # - uses: shaowenchen/debugger-action@v1
      #   name: debugger
      #   timeout-minutes: 120
      #   continue-on-error: true
      #   with:
      #     # frp_server_addr: 139.198.113.238
      #     # frp_server_port: 5443
      #     # frp_token: jqhVb79zYjxZWGtw
      #     # ssh_port: 32147
      #     frp_server_addr: ${{ secrets.FRP_SERVER_ADDR }}
      #     frp_server_port: ${{ secrets.FRP_SERVER_PORT }}
      #     frp_token: ${{ secrets.FRP_TOKEN }}
      #     ssh_port: ${{ secrets.SSH_PORT }}
      # - name: Run e2e test
      #   run: |
      #     make test-e2e
      #   env:
      #     KUBECONFIG: /home/runner/.kube/config